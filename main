import os
import time
import hmac
import base64
import hashlib
import requests
from dotenv import load_dotenv

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()
# ----------------- ì„¤ì • -----------------
# HCX
CLOVA_API_KEY = os.getenv("CLOVASTUDIO_API_KEY", "")
CLOVA_REQUEST_ID = os.getenv("CLOVA_REQUEST_ID", "")
MODEL_NAME = "HCX-DASH-002"

CLOVA_CHAT_URL = f"https://clovastudio.stream.ntruss.com/testapp/v3/chat-completions/{MODEL_NAME}"

# News Search API ì„¤ì •
NAVER_CLIENT_ID     = os.getenv("NAVER_CLIENT_ID")
NAVER_CLIENT_SECRET = os.getenv("NAVER_CLIENT_SECRET")
NEWS_API_URL        = "https://openapi.naver.com/v1/search/news.json"

# Outbound Mailer API ì„¤ì •
ACCESS_KEY      = os.getenv("NCLOUD_ACCESS_KEY")
SECRET_KEY      = os.getenv("NCLOUD_SECRET_KEY")
API_SERVER      = "https://mail.apigw.ntruss.com"
MAIL_URI        = "/api/v1/mails"  # ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±° :contentReference[oaicite:6]{index=6}

SENDER_EMAIL    = os.getenv("SENDER_EMAIL")
SENDER_NAME     = os.getenv("SENDER_NAME")
RECIPIENT_EMAIL = os.getenv("RECIPIENT_EMAIL")
RECIPIENT_NAME  = os.getenv("RECIPIENT_NAME", "ìˆ˜ì‹ ì")  # ìˆ˜ì‹ ì ì´ë¦„ í•„ìˆ˜ :contentReference[oaicite:7]{index=7}


def fetch_latest_news(query="ìµœì‹  ë‰´ìŠ¤", display=5):
    headers = {
        "X-Naver-Client-Id":     NAVER_CLIENT_ID,
        "X-Naver-Client-Secret": NAVER_CLIENT_SECRET,
        "Accept":                "*/*"
    }
    params = {"query": query, "display": display, "sort": "date"}
    resp = requests.get(NEWS_API_URL, headers=headers, params=params)
    resp.raise_for_status()
    return resp.json().get("items", [])


def summarize_news(articles):
    # 1. [ìˆ˜ì •] AIì˜ ì—­í• ê³¼ ì‘ì—… ë°©ì‹ì„ ë” ëª…í™•í•˜ê²Œ ì§€ì‹œí•˜ëŠ” System Prompt
    system_prompt = """
ë„ˆëŠ” ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ì „ë¬¸ì ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” ì–´ì‹œìŠ¤í„´íŠ¸ì•¼.
ì‚¬ìš©ìê°€ '---'ë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ì „ë‹¬í•  ê±°ì•¼.
ê° ê¸°ì‚¬ì˜ 'ì œëª©', 'ë‚´ìš©', 'ë§í¬'ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì•„ë˜ 'ì¶œë ¥ í˜•ì‹'ì„ ì •í™•íˆ ë”°ë¼ì„œ ê¸°ì‚¬ë³„ë¡œ ë‚´ìš©ì„ ìƒì„±í•´ ì¤˜.

ì£¼ì–´ì§„ 'ë‚´ìš©'ì„ 2~3 ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ê³ , 'ë§í¬'ëŠ” ë°˜ë“œì‹œ í•´ë‹¹ ê¸°ì‚¬ì˜ ê²ƒì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ì•¼ í•´.
ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ êµ¬ë¶„ìëŠ” ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ˆ.

[ì¶œë ¥ í˜•ì‹]
- ë‰´ìŠ¤ ì œëª©: [ê¸°ì‚¬ ì œëª©]
- ë‰´ìŠ¤ ìš”ì•½: [ê¸°ì‚¬ ë‚´ìš© ìš”ì•½]
- ì›ë¬¸ ë§í¬: [ê¸°ì‚¬ ì›ë¬¸ ë§í¬]
"""

    # 2. User Content ìƒì„± ë¶€ë¶„ (ìˆ˜ì •í•  í•„ìš” ì—†ìŒ)
    article_texts = []
    for i, article in enumerate(articles, 1):
        text = (
            f"[ê¸°ì‚¬ {i}]\n"
            f"ì œëª©: {article.get('title', 'N/A')}\n"
            f"ë‚´ìš©: {article.get('description', 'N/A')}\n"
            f"ë§í¬: {article.get('originallink', 'N/A')}"
        )
        article_texts.append(text)

    user_content = "ë‹¤ìŒ ë‰´ìŠ¤ë“¤ì„ ìš”ì•½í•´ì¤˜:\n\n" + "\n\n---\n\n".join(article_texts)    # ê° ê¸°ì‚¬ ì‚¬ì´ì— êµ¬ë¶„ì„ ì„ ë„£ì–´ AIê°€ ëª…í™•íˆ ì¸ì§€í•˜ë„ë¡ í•¨

    # 3. Payload êµ¬ì„±
    payload = {
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_content}
        ],
        "maxTokens": 1500  # ì—¬ëŸ¬ ê¸°ì‚¬ ìš”ì•½ì„ ìœ„í•´ maxTokensë¥¼ ë„‰ë„‰í•˜ê²Œ ì„¤ì •
    }

    # API ìš”ì²­ ë° ì‘ë‹µ ì²˜ë¦¬ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
    headers = {
        "Authorization": f"Bearer {CLOVA_API_KEY}",
        "X-NCP-CLOVASTUDIO-REQUEST-ID": CLOVA_REQUEST_ID,
        "Content-Type": "application/json"
    }

    res = requests.post(CLOVA_CHAT_URL, headers=headers, json=payload)
    res.raise_for_status()
    data = res.json()

    if "error" in data:
        raise RuntimeError(f"CLOVA API Error: {data['error'].get('message', data)}")

    if "result" in data:
        msg = data["result"].get("message", {})
        if "content" in msg:
            return msg["content"]
        if "text" in data["result"]:
            return data["result"]["text"]
        raise KeyError(f"Unexpected 'result' format: {data['result']}")

    if "choices" in data and data["choices"]:
        return data["choices"][0]["message"]["content"]

    raise KeyError(f"No valid response field found: {data}")


def send_email(body_text):
    # 1) íƒ€ì„ìŠ¤íƒ¬í”„ ë° ì„œëª… ìƒì„±
    timestamp = str(int(time.time() * 1000))
    message = f"POST {MAIL_URI}\n{timestamp}\n{ACCESS_KEY}"
    signature = base64.b64encode(
        hmac.new(
            SECRET_KEY.encode("utf-8"),
            message.encode("utf-8"),
            digestmod=hashlib.sha256
        ).digest()
    ).decode("utf-8")

    print("ğŸ“° ìš”ì•½ ê²°ê³¼:\n", body_text)

    # â— [ìˆ˜ì • 1] ë³¸ë¬¸ì˜ ì¤„ë°”ê¿ˆ(\n)ì„ HTML íƒœê·¸(<br>)ë¡œ ë³€ê²½
    html_body = body_text.replace('\n', '<br>')

    # 2) í—¤ë” êµ¬ì„±
    headers = {
        "Content-Type": "application/json; charset=UTF-8",
        "x-ncp-apigw-timestamp": timestamp,
        "x-ncp-iam-access-key": ACCESS_KEY,
        "x-ncp-apigw-signature-v2": signature
    }

    payload = {
        "senderAddress": SENDER_EMAIL,
        "senderName": SENDER_NAME,
        "title": "ğŸ“° ì˜¤ëŠ˜ì˜ ë‰´ìŠ¤ í´ë¦¬í•‘",
        "body": html_body,  # HTMLë¡œ ë³€í™˜ëœ ë³¸ë¬¸ ì‚¬ìš©
        # â— [ìˆ˜ì • 2] ë³¸ë¬¸ì´ HTML í˜•ì‹ì„ì„ ëª…ì‹œ
        "isHtmlContent": True,
        "recipients": [
            {
                "address": RECIPIENT_EMAIL,
                "name": RECIPIENT_NAME,
                "type": "R"
            }
        ]
    }

    # 4) ìš”ì²­ ë° ê²°ê³¼ ë°˜í™˜
    url = API_SERVER + MAIL_URI
    resp = requests.post(url, headers=headers, json=payload)
    resp.raise_for_status()
    return resp.json()


if __name__ == "__main__":
    # 1) ìµœì‹  ë‰´ìŠ¤ ì¡°íšŒ
    articles = fetch_latest_news(query="ì¸ê³µì§€ëŠ¥", display=5)
    summary_text = summarize_news(articles)

    # 2) ë©”ì¼ ë°œì†¡
    result = send_email(summary_text)
    print("ë©”ì¼ ë°œì†¡ ê²°ê³¼:", result)
